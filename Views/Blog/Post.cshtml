@model GCUSMS.ViewModels.PostVM
@using Microsoft.AspNetCore.Identity
@inject UserManager<StudentModel> UserManager
@inject SignInManager<StudentModel> SignInManager

@{
    Layout = "~/Views/Shared/_UserLayout.cshtml";
}

@if (Model != null)
{

    ViewData["Title"] = Model.Blog.Title;
    ViewData["HeaderImage"] = Model.Blog.BlogImagePath;
    ViewData["HeaderTitle"] = Model.Blog.Title;
    ViewData["Author"] = $"{Model.Blog.Author.FirstName} {Model.Blog.Author.LastName}";
    ViewData["DateCreated"] = Model.Blog.CreatedOn.ToString("MMMM d, yyyy");
    ViewData["LastUpdated"] = Model.Blog.UpdatedOn.ToString("MMMM d, yyyy");
    ViewData["UpdatedBy"] = Model.Blog.EditedBy;
}

@{
    string imagePath = Url.Content("~/images/Blogs/") + @ViewData["HeaderImage"];
}

@if (Model != null)
{
<section class="section-hero d-flex justify-content-center align-items-center"
         style="background-image:linear-gradient(to bottom, rgba(0, 0, 0, 0.52), rgba(0, 0, 0, 0.73)) , url( @imagePath );
        background-size: cover;
        background-repeat: no-repeat;">
    <div class="container">
        <div class="row ">
            <div class="col-12">
                <div class="d-flex justify-content-center align-items-center">
                    <h1 class="blog-heading">@ViewData["HeaderTitle"]</h1>
                </div>
                <div style="color: white;" class="text-center">
                    <span>By <a class="login-link" style="font-weight:900;" asp-controller="Blog" asp-action="RecommendedBlogs" asp-route-id="@Model.Blog.Author.Id">@ViewData["Author"]</a></span> | 
                    <span>@ViewData["DateCreated"]</span>
                </div>

                @*<div style="color: white;" class="d-flex justify-content-center align-items-center">
                    <h1 class="gallery-heading">@ViewData["HeaderTitle"]</h1>
                    <div class="d-block">
                        <span>By <a asp-controller="Blog" asp-action="RecommendedBlogs" asp-route-id="@Model.Blog.Author.Id">@ViewData["Author"]</a></span>
                        <span>@ViewData["DateCreated"]</span>
                    </div>
                </div>*@
            </div>
        </div>
    </div>
</section>


    <section class="section-blogpost">
        <div class="m-5">
            <div class="row">
                <div class="col-md-8" style="overflow:hidden;">
                    @Html.Raw(Model.Blog.Content)
                    <hr>

                    @if (Model.Blog.EditedBy == "Admin")
                    {
                        <small class="text-muted">Edited by Admin on @Model.Blog.UpdatedOn.ToString("MMMM d, yyyy")</small>
                    }

                    <hr>

                    <div class="comments">
                        <div class="comments-area">
                            <h5 class="mt-5 mb-5"><i class="fa fa-comment"></i> Comments (@Model.Blog.Comments.Count())</h5>

                            <ol class="comment-orderedlist">
                                @if (Model.Blog != null)
                                {
                                    @foreach (var comment in Model.Blog.Comments)
                                    {
                                        <li class="comment">
                                            <div class="comment-body">
                                                <div class="comment-meta">
                                                    <div class="comment-author">
                                                        <img src="~/images/Users/@comment.Author.ProfileImagePath" alt="User" class="avatar">
                                                        <a asp-controller="Blog" asp-action="RecommendedBlogs" asp-route-id="@comment.Author.Id" target="_blank" class="comment-authorname">@comment.Author.FirstName @comment.Author.LastName</a>
                                                    </div>

                                                    <div class="comment-metadata">
                                                        <span class="comment-date">@comment.CommentedOn.ToString("dd MMMM yyyy h:mm tt")</span>

                                                        @if (SignInManager.IsSignedIn(User))
                                                        {
                                                            if (User.IsInRole("Administrator"))
                                                            {
                                                                <a asp-controller="Blog" asp-action="DeleteCommentAdmin" asp-route-id="@comment.Id" onclick="return confirm('You are deleting this comment')"><span class="text-danger">Delete</span></a>
                                                            }
                                                            else
                                                            {

                                                                if (comment.Author.Id == @ViewBag.UserId)
                                                                {
                                                                    <a asp-controller="Blog" asp-action="DeleteComment" asp-route-id="@comment.Id" onclick="return confirm('You are deleting this comment')"><span class="text-danger">Delete</span></a>
                                                                }
                                                            }
                                                        }

                                                    </div>
                                                </div>
                                                <div class="comment-content">
                                                    <p>
                                                        @comment.Content
                                                    </p>
                                                </div>
                                            </div>
                                        </li>
                                    }
                                }
                                else
                                {
                                    <li>
                                        <h1>No Comments to Show</h1>
                                    </li>
                                }
                            </ol>
                        </div>

                        <hr>

                        @if (SignInManager.IsSignedIn(User))
                        {
                            <h6 class="mt-3 mb-3">Add your comment</h6>

                            <div class="row">
                                <form asp-controller="Blog" asp-action="CreateComment" method="post" id="parsley-form" data-parsley-validate="" class="col-12">
                                    <input asp-for="Blog.BlogID" readonly hidden />

                                    <div class="col-12">
                                        <div class="form-group">
                                            <label for="Name">Comment as</label>
                                            <input class="form-control text-muted" id="Name" name="Name" type="text" value="@ViewBag.UserName" disabled>
                                        </div>
                                    </div>

                                    @*data-parsley-minlength="2"*@

                                    <div class="col-12">
                                        <div class="form-group">
                                            <textarea class="form-control" asp-for="Comment.Content" cols="40" rows="5" required="" placeholder="Write here..."></textarea>
                                        </div>

                                        <button type="submit" class="btn btn-maroon mb-sm-5">Post</button>
                                    </div>
                                </form>
                    </div>

                        }
                        else
                        {
                            <a class="text-maroon" asp-area="Identity" asp-page="/Account/Login" asp-route-ReturnUrl="~/Blog/Post/@Model.Blog.BlogID">Login to Comment on this Post</a>
                        }
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="container sideblog">
                        <h3 class="blogrecommendation-heading">Read more blogs by <a asp-controller="Blog" asp-action="RecommendedBlogs" asp-route-id="@Model.Blog.Author.Id" target="_blank">@Model.Blog.Author.FirstName @Model.Blog.Author.LastName</a></h3>
                        <ul class="blogrecommendation-ul">
                            @foreach (var Blogs in Model.BlogRecommendation.OrderBy(x => Guid.NewGuid()).Take(6))
                            {
                                <li>
                                    <div class="blogrecommendation-imagediv">
                                        <a class="blogrecommendation-anchor" asp-controller="Blog" asp-action="Post" asp-route-id="@Blogs.BlogID" target="_blank">
                                            <img class="blogrecommendation-image"
                                                  src="~/images/Blogs/@Blogs.BlogImagePath" alt="Title">
                                        </a>
                                        <div class="blogrecommendation-postinfo">
                                            <h2 class="blogrecommendation-postinfo-title">
                                                <a asp-controller="Blog" asp-action="Post" asp-route-id="@Blogs.BlogID">
                                                    @if (Blogs.Title.Length > 20)
                                                    {
                                                        @(Blogs.Title.Substring(0, 18) + "...")
                                                    }
                                                    else
                                                    {
                                                        @(Blogs.Title)
                                                    }
                                                </a>
                                            </h2>
                                            <div>
                                                <p class="blogrecommendation-date">@Blogs.CreatedOn.ToString("dd MMMM yyyy")</p>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>

                </div>
            </div>
        </div>

    </section>

}
else
{
    <div class="st-height-b100 st-height-lg-b80"></div>
    <div class="st-content">
        <div class="st-height-b100 st-height-lg-b80"></div>
        <div class="text-center mt-5">

            <span class="fas fa-question" style="font-size:17rem; color:#722121"></span>
            <h1 class="m-5">Are you sure this blog existed?</h1>
            <p class="text-muted">
                This Blog is not available
            </p>
            <a class="btn btn-outline-secondary m-3" asp-controller="Home" asp-action="Index">
                <i class="fa fa-arrow-left"></i> Go Back
            </a>

        </div>
    </div>
    <div class="st-height-b100 st-height-lg-b80"></div>
}
